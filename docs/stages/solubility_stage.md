# Solubility Stage  
openCOSMO‑RS Pipeline

The Solubility Stage performs COSMO‑RS solubility prediction using the modern Python/C++ COSMO‑RS engine.  
It consumes `.orcacosmo` files generated by the ORCACOSMO Stage, constructs mixture inputs, runs the COSMO‑RS driver, and produces per‑molecule solubility predictions with full provenance.

This document describes the Solubility Stage in detail for both users and developers.

---

# 1. Purpose

The Solubility Stage:

- Reads `orcacosmo_summary.json` from the ORCACOSMO Stage  
- Groups `.orcacosmo` conformers by InChIKey  
- Loads metadata (melting point, Hfus, Gfus mode, etc.)  
- Builds COSMO‑RS mixture input files  
- Runs the COSMO‑RS engine via the Python/C++ wrapper  
- Writes per‑molecule solubility results  
- Produces a canonical `solubility_results.json`  
- Writes human‑readable summaries  

It is the final scientific stage of the pipeline.

---

# 2. Canonical Input & Output

### **Input**
The stage requires:

```
stage_input = orcacosmo_summary.json
```

This file is copied into:

```
jobs/J-.../inputs/orcacosmo_summary.json
```

### **Output**
The stage declares its canonical output:

```
solubility_results.json
```

and also writes:

```
results/<inchi_key>/
    inputs/
        solute_raw/
        solute/
        solvent/
    mixture_inputs.txt
    raw_output.txt
    solubility.json
    summary.txt

solubility_human_summary.txt
```

These appear under:

```
jobs/J-.../outputs/
```

---

# 3. Parameters & Configuration

The stage reads configuration from:

```
config/paths.json
```

### Required configuration keys

| Key | Description |
|-----|-------------|
| `solubility.defaults` | Default temperature, solvent, etc. |
| `constant_files.metadata_dir` | Molecule metadata directory |
| `constant_files.solvent_dir` | Solvent `.orcacosmo` files |
| `opencosmo.python_src` | Python COSMO‑RS source directory |
| `opencosmo.cpp_bindings` | C++ COSMO‑RS bindings |
| `opencosmo.python_driver` | Driver script for COSMO‑RS |

### Stage parameters

| Parameter | Type | Description |
|----------|------|-------------|
| `temperature` | float | Temperature in K (default from config) |
| `solvent_name` | str | Solvent directory name |
| `verbose` | bool | Extra logging |

---

# 4. Execution Flow

The Solubility Stage follows this sequence:

1. **Prepare directories**  
2. **Load solubility config**  
3. **Load ORCACOSMO summary**  
4. **Group conformers by InChIKey**  
5. **Set items for resume**  
6. **For each solute:**  
   - Load metadata  
   - Copy solute conformers  
   - Copy solvent conformers  
   - Build `mixture_inputs.txt`  
   - Run COSMO‑RS engine  
   - Write raw output  
   - Write `solubility.json`  
   - Write human summary  
7. **Write global summary**  

---

# 5. Directory Structure

For each solute (InChIKey), the stage creates:

```
results/<inchi_key>/
    inputs/
        solute_raw/   # original .orcacosmo files
        solute/       # renamed <InChIKey>_cNNN.orcacosmo
        solvent/      # solvent conformers
    mixture_inputs.txt
    raw_output.txt
    solubility.json
    summary.txt
```

This structure ensures:

- Full provenance  
- Clear separation of raw vs engine‑ready inputs  
- Reproducibility  

---

# 6. Metadata Usage

Metadata is loaded from:

```
CONSTANT_FILES/molecule_metadata/<inchi_key>.json
```

The stage extracts:

- SMILES  
- Melting temperature (`Tm`)  
- Hfus  
- Gfus mode  
- Experimental solubility (if available)  

These values are required for COSMO‑RS mixture construction.

---

# 7. Solute Conformer Handling

The stage:

1. Copies all `.orcacosmo` files into `solute_raw/`  
2. Renames them deterministically into:

```
solute/<inchi_key>_cNNN.orcacosmo
```

This ensures stable ordering and reproducibility.

---

# 8. Solvent Conformer Handling

Solvent conformers are loaded from:

```
CONSTANT_FILES/solvents/<solvent_name>/*.orcacosmo
```

All solvent conformers are copied into:

```
inputs/solvent/
```

---

# 9. Mixture Input Construction

The stage uses:

```
build_mixture_inputs(...)
```

to generate a COSMO‑RS mixture file containing:

- Solute metadata  
- Solute conformer list  
- Solvent conformer list  
- Temperature  
- Default COSMO‑RS parameters  

The mixture file is written to:

```
mixture_inputs.txt
```

If `verbose=True`, the mixture file is logged.

---

# 10. COSMO‑RS Execution

The stage runs the COSMO‑RS engine via:

```
run_legacy_cosmors(...)
```

This function:

- Executes the Python/C++ COSMO‑RS driver  
- Returns:
  - Predicted solubility  
  - Raw stdout  
  - Optional validation file  

Raw output is written to:

```
raw_output.txt
```

If a validation file is produced, it is copied to:

```
import_validation.txt
```

---

# 11. Per‑Molecule Output

Each solute produces:

### **solubility.json**

Contains:

- InChIKey  
- Lookup IDs  
- SMILES  
- Melting temperature  
- Experimental solubility  
- Predicted solubility  
- Temperature  
- Number of solute conformers  
- Number of solvent conformers  
- Path to raw output  

### **summary.txt**

Human‑readable summary including:

- Molecule ID  
- Lookup IDs  
- SMILES  
- Melting temperature  
- Experimental solubility  
- Predicted solubility  
- Absolute error  
- Conformer counts  

---

# 12. Global Summary

The stage writes:

### **solubility_results.json**

A list of all successful solubility entries.

### **solubility_human_summary.txt**

Contains:

- Total molecules  
- Successful / failed counts  
- Per‑molecule summaries  
- Absolute errors  
- Paths to JSON and summary files  

---

# 13. Failure Modes

The stage logs and continues on:

- Missing metadata  
- Missing `.orcacosmo` files  
- COSMO‑RS engine errors  
- Exceptions during mixture building  

Failed molecules are listed in the global summary.

Strict mode is not used in this stage — failures do not halt the pipeline.

---

# 14. Minimal Example

### pipeline_spec entry

```python
{
    "stage": "solubility",
    "args": {
        "solvent_name": "water",
        "temperature": 298.15,
        "verbose": false
    }
}
```

### Running the stage

```
python3 main.py
```

---

# 15. Summary

The Solubility Stage:

- Loads ORCA‑COSMO results  
- Builds COSMO‑RS mixture inputs  
- Runs the COSMO‑RS engine  
- Produces per‑molecule solubility predictions  
- Writes detailed provenance and human‑readable summaries  
- Produces a canonical `solubility_results.json`  

It is the final scientific stage of the openCOSMO‑RS pipeline.

